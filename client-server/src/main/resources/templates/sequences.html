<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth2 / OIDC Lab - Sequence Diagrams</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 40px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 5px;
        }
        .diagram-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .diagram-section h3 {
            margin-top: 0;
            color: #007bff;
        }
        .description {
            color: #666;
            line-height: 1.6;
            margin: 15px 0;
            padding: 15px;
            background: #fff;
            border-radius: 5px;
        }
        .sequence-diagram {
            background: white;
            padding: 30px;
            border-radius: 5px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 14px;
            line-height: 2;
            overflow-x: auto;
        }
        .seq-step {
            margin: 10px 0;
            padding: 8px 15px;
            background: #e7f3ff;
            border-left: 3px solid #007bff;
            border-radius: 3px;
        }
        .seq-step .step-num {
            font-weight: bold;
            color: #007bff;
            display: inline-block;
            min-width: 30px;
        }
        .seq-actor {
            font-weight: bold;
            color: #28a745;
        }
        .seq-arrow {
            color: #dc3545;
            font-weight: bold;
        }
        .seq-note {
            background: #fff3cd;
            padding: 10px 15px;
            margin: 10px 0;
            border-left: 3px solid #ffc107;
            border-radius: 3px;
            font-style: italic;
        }
        .button {
            display: inline-block;
            padding: 10px 20px;
            margin: 20px 5px 0 0;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .info-box {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        .key-points {
            background: #fff;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .key-points ul {
            margin: 10px 0;
            line-height: 1.8;
        }
        .actor-box {
            display: inline-block;
            padding: 5px 10px;
            background: #28a745;
            color: white;
            border-radius: 3px;
            margin: 0 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š å‡¦ç†ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³</h1>
        
        <div class="info-box">
            <strong>ã“ã®ãƒšãƒ¼ã‚¸ã«ã¤ã„ã¦ï¼š</strong>
            OAuth2.0ã¨OpenID Connect (OIDC)ã®å„ãƒ•ãƒ­ãƒ¼ã«ãŠã‘ã‚‹å‡¦ç†ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’å¯è¦–åŒ–ã—ã¦ã„ã¾ã™ã€‚
            å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã®é€šä¿¡ã®æµã‚Œã‚’ç†è§£ã™ã‚‹ãŸã‚ã«ã”æ´»ç”¨ãã ã•ã„ã€‚
        </div>

        <h2>1. OAuth2.0 ãƒ•ãƒ­ãƒ¼ï¼ˆAuthorization Code Grantï¼‰</h2>
        
        <div class="diagram-section">
            <h3>OAuth2.0 å‡¦ç†ã‚·ãƒ¼ã‚±ãƒ³ã‚¹</h3>
            <div class="description">
                <p><strong>æ¦‚è¦ï¼š</strong> Access Tokenã®ã¿ã‚’å–å¾—ã™ã‚‹æ¨™æº–çš„ãªOAuth2.0ã®Authorization Code Grantãƒ•ãƒ­ãƒ¼ã§ã™ã€‚</p>
            </div>
            
            <div class="sequence-diagram">
                <div style="margin-bottom: 20px; text-align: center;">
                    <span class="actor-box">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
                    <span style="margin: 0 20px;">â‡„</span>
                    <span class="actor-box">Client Server (Port: 8081)</span>
                    <span style="margin: 0 20px;">â‡„</span>
                    <span class="actor-box">Authorization Server (Port: 9000)</span>
                </div>
                
                <div class="seq-step">
                    <span class="step-num">1.</span> <span class="seq-actor">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Client</span><br>
                    ã€€ã€€OAuth2ãƒ­ã‚°ã‚¤ãƒ³è¦æ±‚<br>
                    ã€€ã€€<code>/oauth2/authorization/oauth2-client</code>
                </div>
                
                <div class="seq-step">
                    <span class="step-num">2.</span> <span class="seq-actor">Client</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Authorization Server</span><br>
                    ã€€ã€€èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ<br>
                    ã€€ã€€<code>/oauth2/authorize?response_type=code&scope=read,write</code>
                </div>
                
                <div class="seq-step">
                    <span class="step-num">3.</span> <span class="seq-actor">Authorization Server</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span><br>
                    ã€€ã€€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
                </div>
                
                <div class="seq-step">
                    <span class="step-num">4.</span> <span class="seq-actor">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Authorization Server</span><br>
                    ã€€ã€€èªè¨¼æƒ…å ±é€ä¿¡ (user/password)
                </div>
                
                <div class="seq-step">
                    <span class="step-num">5.</span> <span class="seq-actor">Authorization Server</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span><br>
                    ã€€ã€€èªå¯ç”»é¢è¡¨ç¤ºï¼ˆã‚¹ã‚³ãƒ¼ãƒ—æ‰¿èªï¼‰
                </div>
                
                <div class="seq-step">
                    <span class="step-num">6.</span> <span class="seq-actor">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Authorization Server</span><br>
                    ã€€ã€€ã‚¹ã‚³ãƒ¼ãƒ—æ‰¿èª
                </div>
                
                <div class="seq-step">
                    <span class="step-num">7.</span> <span class="seq-actor">Authorization Server</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Client</span><br>
                    ã€€ã€€Authorization Codeè¿”å´ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰
                </div>
                
                <div class="seq-step">
                    <span class="step-num">8.</span> <span class="seq-actor">Client</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Authorization Server</span><br>
                    ã€€ã€€Token Request<br>
                    ã€€ã€€<code>/oauth2/token (grant_type=authorization_code, code=[èªå¯ã‚³ãƒ¼ãƒ‰])</code>
                </div>
                
                <div class="seq-step">
                    <span class="step-num">9.</span> <span class="seq-actor">Authorization Server</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Client</span><br>
                    ã€€ã€€<strong>Access Token</strong> è¿”å´
                </div>
                
                <div class="seq-step">
                    <span class="step-num">10.</span> <span class="seq-actor">Client</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Authorization Server</span><br>
                    ã€€ã€€UserInfoå–å¾—<br>
                    ã€€ã€€<code>/userinfo (Bearer [Access Token])</code>
                </div>
                
                <div class="seq-step">
                    <span class="step-num">11.</span> <span class="seq-actor">Authorization Server</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Client</span><br>
                    ã€€ã€€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¿”å´
                </div>
                
                <div class="seq-step">
                    <span class="step-num">12.</span> <span class="seq-actor">Client</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span><br>
                    ã€€ã€€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º <code>/dashboard</code>
                </div>
            </div>
            
            <div class="key-points">
                <strong>é‡è¦ãªãƒã‚¤ãƒ³ãƒˆï¼š</strong>
                <ul>
                    <li><strong>ã‚¹ã‚³ãƒ¼ãƒ—ï¼š</strong> read, write</li>
                    <li><strong>å–å¾—ãƒˆãƒ¼ã‚¯ãƒ³ï¼š</strong> Access Token ã®ã¿</li>
                    <li><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ï¼š</strong> UserInfo ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆçµŒç”±</li>
                    <li><strong>ID Tokenï¼š</strong> ãªã—</li>
                </ul>
            </div>
        </div>

        <h2>2. OIDC ãƒ•ãƒ­ãƒ¼ï¼ˆOpenID Connectï¼‰</h2>
        
        <div class="diagram-section">
            <h3>OIDC å‡¦ç†ã‚·ãƒ¼ã‚±ãƒ³ã‚¹</h3>
            <div class="description">
                <p><strong>æ¦‚è¦ï¼š</strong> Access Tokenã¨ID Tokenã®ä¸¡æ–¹ã‚’å–å¾—ã™ã‚‹OpenID Connectãƒ•ãƒ­ãƒ¼ã§ã™ã€‚</p>
            </div>
            
            <div class="sequence-diagram">
                <div style="margin-bottom: 20px; text-align: center;">
                    <span class="actor-box">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
                    <span style="margin: 0 20px;">â‡„</span>
                    <span class="actor-box">Client Server (Port: 8081)</span>
                    <span style="margin: 0 20px;">â‡„</span>
                    <span class="actor-box">Authorization Server / OpenID Provider (Port: 9000)</span>
                </div>
                
                <div class="seq-step">
                    <span class="step-num">1.</span> <span class="seq-actor">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Client</span><br>
                    ã€€ã€€OIDCãƒ­ã‚°ã‚¤ãƒ³è¦æ±‚<br>
                    ã€€ã€€<code>/oauth2/authorization/oidc-client</code>
                </div>
                
                <div class="seq-step">
                    <span class="step-num">2.</span> <span class="seq-actor">Client</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Authorization Server</span><br>
                    ã€€ã€€èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ<br>
                    ã€€ã€€<code>/oauth2/authorize?response_type=code&scope=openid,profile,read,write</code>
                </div>
                
                <div class="seq-step">
                    <span class="step-num">3.</span> <span class="seq-actor">Authorization Server</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span><br>
                    ã€€ã€€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
                </div>
                
                <div class="seq-step">
                    <span class="step-num">4.</span> <span class="seq-actor">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Authorization Server</span><br>
                    ã€€ã€€èªè¨¼æƒ…å ±é€ä¿¡ (user/password)
                </div>
                
                <div class="seq-step">
                    <span class="step-num">5.</span> <span class="seq-actor">Authorization Server</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span><br>
                    ã€€ã€€èªå¯ç”»é¢è¡¨ç¤ºï¼ˆã‚¹ã‚³ãƒ¼ãƒ—æ‰¿èªï¼‰
                </div>
                
                <div class="seq-step">
                    <span class="step-num">6.</span> <span class="seq-actor">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Authorization Server</span><br>
                    ã€€ã€€ã‚¹ã‚³ãƒ¼ãƒ—æ‰¿èª
                </div>
                
                <div class="seq-step">
                    <span class="step-num">7.</span> <span class="seq-actor">Authorization Server</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Client</span><br>
                    ã€€ã€€Authorization Codeè¿”å´ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰
                </div>
                
                <div class="seq-step">
                    <span class="step-num">8.</span> <span class="seq-actor">Client</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Authorization Server</span><br>
                    ã€€ã€€Token Request<br>
                    ã€€ã€€<code>/oauth2/token (grant_type=authorization_code, code=[èªå¯ã‚³ãƒ¼ãƒ‰])</code>
                </div>
                
                <div class="seq-step">
                    <span class="step-num">9.</span> <span class="seq-actor">Authorization Server</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Client</span><br>
                    ã€€ã€€<strong>Access Token + ID Token</strong> è¿”å´
                </div>
                
                <div class="seq-note">
                    ğŸ“ Clientå´ã§ID Tokenã‚’æ¤œè¨¼ï¼ˆç½²åã€Issuerã€Audienceç­‰ï¼‰
                </div>
                
                <div class="seq-step">
                    <span class="step-num">10.</span> <span class="seq-actor">Client</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span><br>
                    ã€€ã€€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆID Token Claimså«ã‚€ï¼‰<br>
                    ã€€ã€€<code>/dashboard</code>
                </div>
            </div>
            
            <div class="key-points">
                <strong>é‡è¦ãªãƒã‚¤ãƒ³ãƒˆï¼š</strong>
                <ul>
                    <li><strong>ã‚¹ã‚³ãƒ¼ãƒ—ï¼š</strong> openid, profile, read, write</li>
                    <li><strong>å–å¾—ãƒˆãƒ¼ã‚¯ãƒ³ï¼š</strong> Access Token + ID Token</li>
                    <li><strong>ID Tokenï¼š</strong> ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥æƒ…å ±ï¼ˆClaimsï¼‰ã‚’å«ã‚€JWT</li>
                    <li><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼š</strong> ID Tokenå†…ã®Claimsã‹ã‚‰ç›´æ¥å–å¾—</li>
                    <li><strong>èªè¨¼æƒ…å ±ï¼š</strong> ID Tokenã§æä¾›ï¼ˆUserInfoã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸è¦ï¼‰</li>
                </ul>
            </div>
        </div>

        <h2>3. Resource Server API ã‚¢ã‚¯ã‚»ã‚¹ãƒ•ãƒ­ãƒ¼</h2>
        
        <div class="diagram-section">
            <h3>API ã‚¢ã‚¯ã‚»ã‚¹å‡¦ç†ã‚·ãƒ¼ã‚±ãƒ³ã‚¹</h3>
            <div class="description">
                <p><strong>æ¦‚è¦ï¼š</strong> å–å¾—ã—ãŸAccess Tokenã§Resource Serverï¼ˆAPIï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã®ãƒ•ãƒ­ãƒ¼ã§ã™ã€‚</p>
            </div>
            
            <div class="sequence-diagram">
                <div style="margin-bottom: 20px; text-align: center;">
                    <span class="actor-box">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
                    <span style="margin: 0 20px;">â‡„</span>
                    <span class="actor-box">Client Server</span>
                    <span style="margin: 0 20px;">â‡„</span>
                    <span class="actor-box">Resource Server API</span>
                    <span style="margin: 0 20px;">â‡„</span>
                    <span class="actor-box">Authorization Server</span>
                </div>
                
                <div class="seq-note">
                    ğŸ“ å‰æï¼šèªè¨¼æ¸ˆã¿ï¼ˆAccess Tokenä¿æŒï¼‰
                </div>
                
                <div class="seq-step">
                    <span class="step-num">1.</span> <span class="seq-actor">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Client</span><br>
                    ã€€ã€€APIãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯<br>
                    ã€€ã€€<code>/api/user</code> ã¾ãŸã¯ <code>/api/data</code>
                </div>
                
                <div class="seq-step">
                    <span class="step-num">2.</span> <span class="seq-actor">Client</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Resource Server API</span><br>
                    ã€€ã€€API Request<br>
                    ã€€ã€€<code>Authorization: Bearer [Access Token]</code>
                </div>
                
                <div class="seq-note">
                    ğŸ” JWTæ¤œè¨¼é–‹å§‹
                </div>
                
                <div class="seq-step">
                    <span class="step-num">3.</span> <span class="seq-actor">Resource Server API</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Authorization Server</span><br>
                    ã€€ã€€JWKså–å¾—ï¼ˆåˆå›ã®ã¿ã€ä»¥é™ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰<br>
                    ã€€ã€€<code>/oauth2/jwks</code>
                </div>
                
                <div class="seq-step">
                    <span class="step-num">4.</span> <span class="seq-actor">Authorization Server</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Resource Server API</span><br>
                    ã€€ã€€å…¬é–‹éµè¿”å´
                </div>
                
                <div class="seq-note">
                    ğŸ” JWTç½²åæ¤œè¨¼ã€æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ã€ã‚¹ã‚³ãƒ¼ãƒ—æ¤œè¨¼
                </div>
                
                <div class="seq-step">
                    <span class="step-num">5a.</span> <strong style="color: #28a745;">âœ“ JWTæ¤œè¨¼æˆåŠŸ</strong><br>
                    ã€€ã€€<span class="seq-actor">Resource Server API</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Client</span><br>
                    ã€€ã€€API Response (200 OK)<br>
                    ã€€ã€€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
                </div>
                
                <div class="seq-step">
                    <span class="step-num">5b.</span> <strong style="color: #dc3545;">âœ— JWTæ¤œè¨¼å¤±æ•—</strong><br>
                    ã€€ã€€<span class="seq-actor">Resource Server API</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">Client</span><br>
                    ã€€ã€€Error Response (401 Unauthorized)
                </div>
                
                <div class="seq-step">
                    <span class="step-num">6.</span> <span class="seq-actor">Client</span> <span class="seq-arrow">â†’</span> <span class="seq-actor">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span><br>
                    ã€€ã€€çµæœè¡¨ç¤º
                </div>
            </div>
            
            <div class="key-points">
                <strong>é‡è¦ãªãƒã‚¤ãƒ³ãƒˆï¼š</strong>
                <ul>
                    <li><strong>èªè¨¼æ–¹å¼ï¼š</strong> Bearer Tokenï¼ˆJWTã¨ã—ã¦æ¤œè¨¼ï¼‰</li>
                    <li><strong>JWTæ¤œè¨¼ï¼š</strong> ç½²åã€æœ‰åŠ¹æœŸé™ã€Issuerã€Audienceã‚’ãƒã‚§ãƒƒã‚¯</li>
                    <li><strong>å…¬é–‹éµå–å¾—ï¼š</strong> JWKs ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ï¼‰</li>
                    <li><strong>ä¿è­·å¯¾è±¡APIï¼š</strong> /api/user, /api/data</li>
                </ul>
            </div>
        </div>

        <div class="info-box">
            <strong>ğŸ’¡ OAuth2.0ã¨OIDCã®ä¸»ãªé•ã„ï¼š</strong><br>
            <ul style="margin: 10px 0; line-height: 1.8;">
                <li><strong>OAuth2.0ï¼š</strong> èªå¯ï¼ˆAuthorizationï¼‰ãŒä¸»ç›®çš„ã€‚Access Tokenã®ã¿å–å¾—ã—ã€UserInfoã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—</li>
                <li><strong>OIDCï¼š</strong> èªè¨¼ï¼ˆAuthenticationï¼‰ãŒä¸»ç›®çš„ã€‚ID Tokenã§ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥æƒ…å ±ã‚’ç›´æ¥å–å¾—ã§ãã€èªè¨¼ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æä¾›</li>
            </ul>
        </div>

        <div style="margin-top: 40px;">
            <a href="/" class="button">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
        </div>
    </div>
</body>
</html>
