<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth2 / OIDC Lab - Sequence Diagrams</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 40px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 5px;
        }
        .diagram-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .diagram-section h3 {
            margin-top: 0;
            color: #007bff;
        }
        .description {
            color: #666;
            line-height: 1.6;
            margin: 15px 0;
            padding: 15px;
            background: #fff;
            border-radius: 5px;
        }
        .mermaid {
            background: white;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }
        .button {
            display: inline-block;
            padding: 10px 20px;
            margin: 20px 5px 0 0;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .info-box {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        .key-points {
            background: #fff;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .key-points ul {
            margin: 10px 0;
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š å‡¦ç†ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³</h1>
        
        <div class="info-box">
            <strong>ã“ã®ãƒšãƒ¼ã‚¸ã«ã¤ã„ã¦ï¼š</strong>
            OAuth2.0ã¨OpenID Connect (OIDC)ã®å„ãƒ•ãƒ­ãƒ¼ã«ãŠã‘ã‚‹å‡¦ç†ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’å¯è¦–åŒ–ã—ã¦ã„ã¾ã™ã€‚
            å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã®é€šä¿¡ã®æµã‚Œã‚’ç†è§£ã™ã‚‹ãŸã‚ã«ã”æ´»ç”¨ãã ã•ã„ã€‚
        </div>

        <h2>1. OAuth2.0 ãƒ•ãƒ­ãƒ¼ï¼ˆAuthorization Code Grantï¼‰</h2>
        
        <div class="diagram-section">
            <h3>OAuth2.0 å‡¦ç†ã‚·ãƒ¼ã‚±ãƒ³ã‚¹</h3>
            <div class="description">
                <p><strong>æ¦‚è¦ï¼š</strong> Access Tokenã®ã¿ã‚’å–å¾—ã™ã‚‹æ¨™æº–çš„ãªOAuth2.0ã®Authorization Code Grantãƒ•ãƒ­ãƒ¼ã§ã™ã€‚</p>
            </div>
            
            <div class="mermaid">
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼<br/>(ãƒ–ãƒ©ã‚¦ã‚¶)
    participant Client as Client Server<br/>(Port: 8081)
    participant AuthzServer as Authorization Server<br/>(Port: 9000)
    
    User->>Client: 1. OAuth2ãƒ­ã‚°ã‚¤ãƒ³è¦æ±‚<br/>/oauth2/authorization/oauth2-client
    Client->>AuthzServer: 2. èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ<br/>/oauth2/authorize<br/>response_type=code<br/>scope=read,write
    AuthzServer->>User: 3. ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
    User->>AuthzServer: 4. èªè¨¼æƒ…å ±é€ä¿¡<br/>(user/password)
    AuthzServer->>User: 5. èªå¯ç”»é¢è¡¨ç¤º<br/>(ã‚¹ã‚³ãƒ¼ãƒ—æ‰¿èª)
    User->>AuthzServer: 6. ã‚¹ã‚³ãƒ¼ãƒ—æ‰¿èª
    AuthzServer->>Client: 7. Authorization Codeè¿”å´<br/>ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    Client->>AuthzServer: 8. Token Request<br/>/oauth2/token<br/>grant_type=authorization_code<br/>code=[èªå¯ã‚³ãƒ¼ãƒ‰]
    AuthzServer->>Client: 9. Access Tokenè¿”å´
    Client->>AuthzServer: 10. UserInfoå–å¾—<br/>/userinfo<br/>Bearer [Access Token]
    AuthzServer->>Client: 11. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¿”å´
    Client->>User: 12. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º<br/>/dashboard
            </div>
            
            <div class="key-points">
                <strong>é‡è¦ãªãƒã‚¤ãƒ³ãƒˆï¼š</strong>
                <ul>
                    <li><strong>ã‚¹ã‚³ãƒ¼ãƒ—ï¼š</strong> read, write</li>
                    <li><strong>å–å¾—ãƒˆãƒ¼ã‚¯ãƒ³ï¼š</strong> Access Token ã®ã¿</li>
                    <li><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ï¼š</strong> UserInfo ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆçµŒç”±</li>
                    <li><strong>ID Tokenï¼š</strong> ãªã—</li>
                </ul>
            </div>
        </div>

        <h2>2. OIDC ãƒ•ãƒ­ãƒ¼ï¼ˆOpenID Connectï¼‰</h2>
        
        <div class="diagram-section">
            <h3>OIDC å‡¦ç†ã‚·ãƒ¼ã‚±ãƒ³ã‚¹</h3>
            <div class="description">
                <p><strong>æ¦‚è¦ï¼š</strong> Access Tokenã¨ID Tokenã®ä¸¡æ–¹ã‚’å–å¾—ã™ã‚‹OpenID Connectãƒ•ãƒ­ãƒ¼ã§ã™ã€‚</p>
            </div>
            
            <div class="mermaid">
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼<br/>(ãƒ–ãƒ©ã‚¦ã‚¶)
    participant Client as Client Server<br/>(Port: 8081)
    participant AuthzServer as Authorization Server<br/>(OpenID Provider)<br/>(Port: 9000)
    
    User->>Client: 1. OIDCãƒ­ã‚°ã‚¤ãƒ³è¦æ±‚<br/>/oauth2/authorization/oidc-client
    Client->>AuthzServer: 2. èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ<br/>/oauth2/authorize<br/>response_type=code<br/>scope=openid,profile,read,write
    AuthzServer->>User: 3. ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
    User->>AuthzServer: 4. èªè¨¼æƒ…å ±é€ä¿¡<br/>(user/password)
    AuthzServer->>User: 5. èªå¯ç”»é¢è¡¨ç¤º<br/>(ã‚¹ã‚³ãƒ¼ãƒ—æ‰¿èª)
    User->>AuthzServer: 6. ã‚¹ã‚³ãƒ¼ãƒ—æ‰¿èª
    AuthzServer->>Client: 7. Authorization Codeè¿”å´<br/>ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    Client->>AuthzServer: 8. Token Request<br/>/oauth2/token<br/>grant_type=authorization_code<br/>code=[èªå¯ã‚³ãƒ¼ãƒ‰]
    AuthzServer->>Client: 9. Access Token + ID Tokenè¿”å´
    Note over Client: ID Tokenã‚’æ¤œè¨¼<br/>(ç½²åã€Issuerã€Audienceç­‰)
    Client->>User: 10. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º<br/>/dashboard<br/>(ID Token Claimså«ã‚€)
            </div>
            
            <div class="key-points">
                <strong>é‡è¦ãªãƒã‚¤ãƒ³ãƒˆï¼š</strong>
                <ul>
                    <li><strong>ã‚¹ã‚³ãƒ¼ãƒ—ï¼š</strong> openid, profile, read, write</li>
                    <li><strong>å–å¾—ãƒˆãƒ¼ã‚¯ãƒ³ï¼š</strong> Access Token + ID Token</li>
                    <li><strong>ID Tokenï¼š</strong> ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥æƒ…å ±ï¼ˆClaimsï¼‰ã‚’å«ã‚€JWT</li>
                    <li><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼š</strong> ID Tokenå†…ã®Claimsã‹ã‚‰ç›´æ¥å–å¾—</li>
                    <li><strong>èªè¨¼æƒ…å ±ï¼š</strong> ID Tokenã§æä¾›ï¼ˆUserInfoã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸è¦ï¼‰</li>
                </ul>
            </div>
        </div>

        <h2>3. Resource Server API ã‚¢ã‚¯ã‚»ã‚¹ãƒ•ãƒ­ãƒ¼</h2>
        
        <div class="diagram-section">
            <h3>API ã‚¢ã‚¯ã‚»ã‚¹å‡¦ç†ã‚·ãƒ¼ã‚±ãƒ³ã‚¹</h3>
            <div class="description">
                <p><strong>æ¦‚è¦ï¼š</strong> å–å¾—ã—ãŸAccess Tokenã§Resource Serverï¼ˆAPIï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã®ãƒ•ãƒ­ãƒ¼ã§ã™ã€‚</p>
            </div>
            
            <div class="mermaid">
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼<br/>(ãƒ–ãƒ©ã‚¦ã‚¶)
    participant Client as Client Server<br/>(Port: 8081)
    participant API as Resource Server API<br/>(Port: 8081)
    participant AuthzServer as Authorization Server<br/>(Port: 9000)
    
    Note over User,Client: èªè¨¼æ¸ˆã¿ï¼ˆAccess Tokenä¿æŒï¼‰
    User->>Client: 1. APIãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯<br/>(/api/user ã¾ãŸã¯ /api/data)
    Client->>API: 2. API Request<br/>Authorization: Bearer [Access Token]
    Note over API: JWTæ¤œè¨¼é–‹å§‹
    API->>AuthzServer: 3. JWKså–å¾—ï¼ˆåˆå›ã®ã¿ï¼‰<br/>/oauth2/jwks
    AuthzServer->>API: 4. å…¬é–‹éµè¿”å´
    Note over API: JWTç½²åæ¤œè¨¼<br/>æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯<br/>ã‚¹ã‚³ãƒ¼ãƒ—æ¤œè¨¼
    alt JWTæ¤œè¨¼æˆåŠŸ
        API->>Client: 5. API Response (200 OK)<br/>ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
        Client->>User: 6. çµæœè¡¨ç¤º
    else JWTæ¤œè¨¼å¤±æ•—
        API->>Client: 5. Error Response (401 Unauthorized)
        Client->>User: 6. ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    end
            </div>
            
            <div class="key-points">
                <strong>é‡è¦ãªãƒã‚¤ãƒ³ãƒˆï¼š</strong>
                <ul>
                    <li><strong>èªè¨¼æ–¹å¼ï¼š</strong> Bearer Tokenï¼ˆJWTã¨ã—ã¦æ¤œè¨¼ï¼‰</li>
                    <li><strong>JWTæ¤œè¨¼ï¼š</strong> ç½²åã€æœ‰åŠ¹æœŸé™ã€Issuerã€Audienceã‚’ãƒã‚§ãƒƒã‚¯</li>
                    <li><strong>å…¬é–‹éµå–å¾—ï¼š</strong> JWKs ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ï¼‰</li>
                    <li><strong>ä¿è­·å¯¾è±¡APIï¼š</strong> /api/user, /api/data</li>
                </ul>
            </div>
        </div>

        <div class="info-box">
            <strong>ğŸ’¡ OAuth2.0ã¨OIDCã®ä¸»ãªé•ã„ï¼š</strong><br>
            <ul style="margin: 10px 0; line-height: 1.8;">
                <li><strong>OAuth2.0ï¼š</strong> èªå¯ï¼ˆAuthorizationï¼‰ãŒä¸»ç›®çš„ã€‚Access Tokenã®ã¿å–å¾—ã—ã€UserInfoã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—</li>
                <li><strong>OIDCï¼š</strong> èªè¨¼ï¼ˆAuthenticationï¼‰ãŒä¸»ç›®çš„ã€‚ID Tokenã§ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥æƒ…å ±ã‚’ç›´æ¥å–å¾—ã§ãã€èªè¨¼ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æä¾›</li>
            </ul>
        </div>

        <div style="margin-top: 40px;">
            <a href="/" class="button">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
        </div>
    </div>
</body>
</html>
